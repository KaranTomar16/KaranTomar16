name: Update Weather

on:
  schedule:
    - cron: '0 */3 * * *'  # Runs every 3 hours
  workflow_dispatch:  # Allows manual trigger

jobs:
  update-weather:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install requests pytz

      - name: Update weather data
        env:
          OPENWEATHER_API_KEY: 439d4b804bc8187953eb36d2a8c26a02
        run: |
          python - <<EOF
          import requests
          import json
          from datetime import datetime
          import pytz

          # Fetch weather data
          api_key = "${{ env.OPENWEATHER_API_KEY }}"
          city = "Hyderabad,IN"
          url = f"https://api.openweathermap.org/data/2.5/weather?q={city}&appid={api_key}&units=metric"
          
          response = requests.get(url)
          data = response.json()
          
          # Extract weather information
          weather_desc = data['weather'][0]['description'].title()
          temp = f"{data['main']['temp']:.0f}Â°C"
          humidity = f"{data['main']['humidity']}%"
          
          # Convert sunrise/sunset from UTC to IST
          ist = pytz.timezone('Asia/Kolkata')
          sunrise_utc = datetime.fromtimestamp(data['sys']['sunrise'], tz=pytz.UTC)
          sunset_utc = datetime.fromtimestamp(data['sys']['sunset'], tz=pytz.UTC)
          sunrise_ist = sunrise_utc.astimezone(ist).strftime('%I:%M %p')
          sunset_ist = sunset_utc.astimezone(ist).strftime('%I:%M %p')
          
          # Get weather icon
          icon_code = data['weather'][0]['icon']
          
          # Read README
          with open('README.md', 'r', encoding='utf-8') as f:
              readme = f.read()
          
          # Create weather table
          weather_table = f'''<!-- Hyderabad's weather table -->

          <h2 align="center"> ğŸ‡®ğŸ‡³ Hyderabad's Weather â›… </h2>
          <table align="center" style="width:50%">
              <tr style="text-align:center">
                  <th>Weather</th>
                  <th>Temperature</th>
                  <th>Sunrise</th>
                  <th>Sunset</th>
                  <th>Humidity</th>
              </tr>
              <tr style="text-align:center">
                  <td><b>{weather_desc}</b> <img width="20" src="http://openweathermap.org/img/w/{icon_code}.png"></td>
                  <td><b>{temp}</b></td>
                  <td><b>{sunrise_ist}</b></td>
                  <td><b>{sunset_ist}</b></td>
                  <td><b>{humidity}</b></td>
              </tr>
          </table>'''
          
          # Replace weather section
          start_marker = "<!-- Hyderabad's weather table -->"
          end_marker = "</table>"
          
          start_idx = readme.find(start_marker)
          if start_idx != -1:
              end_idx = readme.find(end_marker, start_idx) + len(end_marker)
              readme = readme[:start_idx] + weather_table + readme[end_idx:]
          
          # Write updated README
          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(readme)
          
          print(f"Weather updated: {weather_desc}, {temp}, {humidity}")
          EOF

      - name: Commit and push if changed
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸŒ¤ï¸ Auto-update weather data" && git push)
